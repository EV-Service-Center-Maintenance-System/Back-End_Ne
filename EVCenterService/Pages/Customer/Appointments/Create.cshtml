@page
@model EVCenterService.Pages.Customer.Appointments.CreateModel
@{
    Layout = "_CustomerLayout";
    ViewData["Title"] = "Create Booking/Order";
}

<h2 class="mb-4">Đặt lịch dịch vụ</h2>

<form method="post" class="card data-card p-4">

    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
    <div class="form-group mb-3">
        <label class="fw-bold">Chọn xe:</label>
        <select id="select-vehicle" asp-for="Booking.VehicleId" asp-items="Model.VehicleList" class="form-select" required>
        </select>
    </div>

    <div class="form-group mb-3">
        <label class="fw-bold">Chọn các dịch vụ:</label>
        <div class="row">

            @foreach (var svc in Model.ServiceList)
            {
                // Mặc định
                var price = svc.BasePrice ?? 0;
                var priceText = $"{price.ToString("N0")} đ";
                var labelClass = ""; // Class CSS để làm nổi bật (tùy chọn)

                // Nếu là "General Inspection" (ID=4) VÀ đủ điều kiện
                if (svc.ServiceId == 4 && Model.IsEligibleForFreeInspection)
                {
                    price = 0; // Sửa giá data-price thành 0
                    priceText = "Miễn phí (Gói dịch vụ)"; // Sửa nhãn
                    labelClass = "text-success fw-bold"; // Đổi màu nhãn (tùy chọn)
                }

                <div class="col-md-6 mb-2">
                    <div class="form-check">
                        <input class="form-check-input service-checkbox"
                               type="checkbox"
                               name="SelectedServiceIds"
                               value="@svc.ServiceId"
                               data-price="@price" id="svc_@svc.ServiceId" />
                        <label class="form-check-label @labelClass" for="svc_@svc.ServiceId">
                            @svc.Name (@priceText)
                        </label>
                    </div>
                </div>
            }
        </div>
        <small class="text-muted d-block mt-1">Bạn có thể chọn nhiều dịch vụ cùng lúc.</small>
    </div>

    <div id="priceSection" class="form-group mb-3" style="display:none;">
        <label class="fw-bold">Tổng chi phí:</label>
        <input id="totalPrice" type="text" class="form-control" readonly value="0 đ" />
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label class="fw-bold">Ngày hẹn:</label>
                <input asp-for="Booking.AppointmentDate"
                       type="date"
                       class="form-control"
                       min="@DateTime.Now.ToString("yyyy-MM-dd")"
                       required />
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label class="fw-bold">Giờ hẹn:</label>
                <input asp-for="SelectedTime"
                       id="SelectedTime"
                       type="time"
                       class="form-control"
                       required />
                <small class="text-muted">Giờ làm việc: 07:00 – 19:00</small>
            </div>
        </div>
    </div>

    <div class="form-group mb-3">
        <label class="fw-bold">Ghi chú (tùy chọn):</label>
        <textarea asp-for="Booking.ChecklistNote"
                  class="form-control"
                  rows="2"
                  placeholder="VD: kiểm tra phanh, thay dầu, vệ sinh nội thất..."></textarea>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Gửi yêu cầu</button>
        <a asp-page="/Index" class="btn btn-secondary ms-2">Hủy</a>
    </div>
</form>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            new TomSelect('#select-vehicle', {
                placeholder: '-- Chọn xe của bạn --',
                create: false, 
                sortField: {
                    field: "text",
                    direction: "asc"
                }
            });

            // ====== Logic tổng giá ======
            const checkboxes = document.querySelectorAll(".service-checkbox");
            const totalPriceInput = document.getElementById("totalPrice");
            const priceSection = document.getElementById("priceSection");

            function updateTotalPrice() {
                let total = 0;
                let checkedCount = 0;

                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        total += parseFloat(cb.dataset.price || 0);
                        checkedCount++;
                    }
                });

                if (checkedCount > 0) {
                    totalPriceInput.value = total.toLocaleString("vi-VN") + " đ";
                    priceSection.style.display = "block";
                } else {
                    priceSection.style.display = "none";
                }
            }

            checkboxes.forEach(chk => chk.addEventListener("change", updateTotalPrice));
            // Chạy lần đầu khi tải trang
            updateTotalPrice();

            // ===== BẮT ĐẦU LOGIC VÔ HIỆU HÓA DỊCH VỤ =====
            // ID Dịch vụ (phải khớp CSDL)
            const generalInspectionId = 4;
            const mainServiceIds = [1, 2, 3]; // Battery, Brake, Cooling

            const generalCheckbox = document.getElementById('svc_' + generalInspectionId);
            const mainCheckboxes = mainServiceIds.map(id => document.getElementById('svc_' + id));

            function handleInspectionLogic() {
                if (generalCheckbox.checked) {
                    // 1. NẾU CHỌN "General Inspection"
                    mainCheckboxes.forEach(chk => {
                        if (chk.checked) {
                            chk.checked = false; // Bỏ chọn
                        }
                        chk.disabled = true; // Vô hiệu hóa
                        chk.closest('.form-check').classList.add('text-muted');
                    });
                } else {
                    // 2. NẾU BỎ CHỌN "General Inspection"
                    mainCheckboxes.forEach(chk => {
                        chk.disabled = false; // Kích hoạt lại
                        chk.closest('.form-check').classList.remove('text-muted');
                    });
                }

                // Tính lại tổng giá sau khi thay đổi
                updateTotalPrice();
            }

            if (generalCheckbox) {
                generalCheckbox.addEventListener('change', handleInspectionLogic);
            }


            // ====== Logic chọn giờ ======
            const timeInput = document.getElementById("SelectedTime");
            const dateInput = document.querySelector('input[name="Booking.AppointmentDate"]');
            const workStart = 7;
            const workEnd = 19;

            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();

            // Giới hạn khung giờ
            timeInput.min = `${String(workStart).padStart(2, "0")}:00`;
            timeInput.max = `${String(workEnd).padStart(2, "0")}:00`;

            // Giờ mặc định
            let defaultHour = currentHour;
            if (currentHour < workStart) defaultHour = workStart;
            else if (currentHour >= workEnd) defaultHour = workEnd - 1;
            const defaultTime = `${String(defaultHour).padStart(2, "0")}:${String(currentMinute).padStart(2, "0")}`;

            if (!timeInput.value) {
                timeInput.value = defaultTime;
            }

            // Khi người dùng đổi ngày hoặc giờ, kiểm tra hợp lệ
            function validateTime() {
                const selectedDate = dateInput.value;
                const today = new Date().toISOString().split("T")[0];
                const [hour, minute] = timeInput.value.split(":").map(Number);

                // Ngoài khung giờ
                if (hour < workStart || (hour === workEnd && minute > 0)) {
                    alert("Vui lòng chọn giờ trong khung 07:00 – 19:00.");
                    timeInput.value = defaultTime;
                    return;
                }

                // Nếu hôm nay, không được chọn giờ đã qua
                if (selectedDate === today && (hour < currentHour || (hour === currentHour && minute < currentMinute))) {
                    alert("Không thể chọn giờ đã qua trong hôm nay!");
                    timeInput.value = defaultTime;
                    return;
                }
            }

            timeInput.addEventListener("change", validateTime);
            dateInput.addEventListener("change", validateTime);
        });
    </script>
}