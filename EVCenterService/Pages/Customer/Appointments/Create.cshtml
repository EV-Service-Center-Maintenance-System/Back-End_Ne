@page
@model EVCenterService.Pages.Customer.Appointments.CreateModel
@{
    // Sử dụng layout dành cho khách hàng
    Layout = "_CustomerLayout";
    ViewData["Title"] = "Create Booking/Order";
}

<div class="page-header header-card-blue">
    <h1 class="mb-0">Đặt lịch dịch vụ</h1>
</div>

<form method="post" class="card data-card p-4 mt-4">

    @if (!ModelState.IsValid)
    {
        <div asp-validation-summary="All" class="alert alert-danger"></div>
    }

    <div class="form-group mb-3">
        <label class="fw-bold">Chọn xe:</label>
        <select id="select-vehicle" asp-for="Booking.VehicleId" asp-items="Model.VehicleList" class="form-select" required>
        </select>
    </div>

    <div class="form-group mb-3">
        <label class="fw-bold">Chọn các dịch vụ:</label>
        <div class="row">

            @foreach (var svc in Model.ServiceList)
            {
                // LUÔN LUÔN lấy giá gốc từ DB để hiển thị
                var originalPrice = svc.BasePrice ?? 0;
                var priceText = $"{originalPrice.ToString("N0")} đ";

                var note = "";
                // Nếu là General Inspection (ID=4), hiển thị dòng nhắc nhở
                if (svc.ServiceId == 4)
                {
                    note = " (Hệ thống sẽ tự động giảm còn 0đ nếu bạn còn lượt miễn phí)";
                    note = $"<span class='text-success fst-italic'>{note}</span>";
                }

                <div class="col-md-6 mb-2">
                    <div class="form-check">
                        <input class="form-check-input service-checkbox"
                               type="checkbox"
                               name="SelectedServiceIds"
                               value="@svc.ServiceId"
                               data-price="@originalPrice"
                               id="svc_@svc.ServiceId" />

                        <label class="form-check-label" for="svc_@svc.ServiceId">
                            @svc.Name (@priceText)
                            <small>@Html.Raw(note)</small>
                        </label>
                    </div>
                </div>
            }
        </div>
        <small class="text-muted d-block mt-1">Bạn có thể chọn nhiều dịch vụ cùng lúc.</small>
    </div>

    <div id="priceSection" class="form-group mb-3" style="display:none;">
        <label class="fw-bold">Tổng chi phí (Ước tính):</label>
        <input id="totalPrice" type="text" class="form-control" readonly value="0 đ" />
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label class="fw-bold">Ngày hẹn:</label>
                <input asp-for="Booking.AppointmentDate"
                       type="date"
                       class="form-control"
                       min="@DateTime.Now.ToString("yyyy-MM-dd")"
                       required />
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group mb-3">
                <label class="fw-bold">Giờ hẹn:</label>
                <input asp-for="SelectedTime"
                       id="SelectedTime"
                       type="time"
                       class="form-control"
                       required />
                <span asp-validation-for="SelectedTime" class="text-danger small"></span>

                <small class="text-muted d-block">Giờ làm việc: 07:00 – 19:00</small>
            </div>
        </div>
    </div>

    <div class="form-group mb-3">
        <label class="fw-bold">Ghi chú (tùy chọn):</label>
        <textarea asp-for="Booking.ChecklistNote"
                  class="form-control"
                  rows="2"
                  placeholder="VD: kiểm tra phanh, thay dầu, vệ sinh nội thất..."></textarea>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Gửi yêu cầu</button>
        <a asp-page="/Index" class="btn btn-secondary ms-2">Hủy</a>
    </div>
</form>

<hr>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // 1. Khởi tạo TomSelect cho ô chọn xe
            new TomSelect('#select-vehicle', {
                placeholder: '-- Chọn xe của bạn --',
                create: false,
                sortField: {
                    field: "text",
                    direction: "asc"
                }
            });

            // ====== 2. LOGIC TỔNG GIÁ ======
            const checkboxes = document.querySelectorAll(".service-checkbox");
            const totalPriceInput = document.getElementById("totalPrice");
            const priceSection = document.getElementById("priceSection");

            /**
             * Cập nhật tổng chi phí dự kiến dựa trên các dịch vụ đã chọn.
             * Nếu không có dịch vụ nào, ẩn phần giá tiền.
             */
            function updateTotalPrice() {
                let total = 0;
                let checkedCount = 0;
                checkboxes.forEach(cb => {
                    // Dùng dataset.price (giá gốc) để tính tổng
                    if (cb.checked) {
                        total += parseFloat(cb.dataset.price || 0);
                        checkedCount++;
                    }
                });
                if (checkedCount > 0) {
                    // Hiển thị tổng giá tiền đã định dạng
                    totalPriceInput.value = total.toLocaleString("vi-VN") + " đ";
                    priceSection.style.display = "block";
                } else {
                    priceSection.style.display = "none";
                }
            }

            checkboxes.forEach(chk => chk.addEventListener("change", updateTotalPrice));
            updateTotalPrice(); // Chạy lần đầu khi tải trang

            // ===== 3. LOGIC VÔ HIỆU HÓA DỊCH VỤ (Nếu chọn General Inspection ID=4) =====
            const generalInspectionId = 4;
            // Giả sử các dịch vụ khác (Main Services) là 1, 2, 3
            const mainServiceIds = [1, 2, 3];
            const generalCheckbox = document.getElementById('svc_' + generalInspectionId);
            const mainCheckboxes = mainServiceIds.map(id => document.getElementById('svc_' + id)).filter(el => el != null);

            /**
             * Xử lý ràng buộc: Nếu General Inspection được chọn, các dịch vụ chính khác sẽ bị vô hiệu hóa.
             */
            function handleInspectionLogic() {
                if (generalCheckbox && generalCheckbox.checked) {
                    mainCheckboxes.forEach(chk => {
                        if (chk.checked) chk.checked = false; // Bỏ chọn nếu đang chọn
                        chk.disabled = true; // Vô hiệu hóa
                        chk.closest('.form-check').classList.add('text-muted'); // Làm mờ
                    });
                } else if (generalCheckbox) {
                    mainCheckboxes.forEach(chk => {
                        chk.disabled = false; // Kích hoạt lại
                        chk.closest('.form-check').classList.remove('text-muted'); // Bỏ làm mờ
                    });
                }
                updateTotalPrice(); // Cập nhật lại tổng giá sau khi thay đổi checkbox
            }

            if (generalCheckbox) {
                generalCheckbox.addEventListener('change', handleInspectionLogic);
                handleInspectionLogic(); // Chạy lần đầu khi tải trang
            }

            // ===== 4. LOGIC CHỌN GIỜ VÀ KIỂM TRA RÀNG BUỘC (Đã sửa lỗi) =====
            const timeInput = document.getElementById("SelectedTime");
            const dateInput = document.querySelector('input[name="Booking.AppointmentDate"]');

            // Giờ làm việc và thời gian đệm
            const workStartHour = 7; // 7:00
            const workEndHour = 19; // 19:00
            const bufferHours = 2; // Thời gian đệm (đặt trước 2 tiếng)
            const minServiceTimeMinutes = 30; // Giả định thời gian dịch vụ ngắn nhất là 30 phút

            // Đặt giới hạn min/max cho ô input (để trình duyệt hỗ trợ)
            if (timeInput) {
                timeInput.min = `${String(workStartHour).padStart(2, "0")}:00`;
                timeInput.max = `${String(workEndHour).padStart(2, "0")}:00`;
            }

            /**
             * Thiết lập giờ mặc định (Giờ sớm nhất có thể đặt)
             */
            function setDefaultTime() {
                if (!timeInput || !dateInput) return;

                const now = new Date();
                // Giờ sớm nhất có thể đặt = Hiện tại + 2 tiếng đệm
                let earliestBookingTime = new Date(now.getTime() + bufferHours * 60 * 60 * 1000);

                let defaultHour = earliestBookingTime.getHours();
                let defaultMinute = earliestBookingTime.getMinutes();

                // 1. Nếu giờ sớm nhất < 7h sáng
                if (defaultHour < workStartHour) {
                    defaultHour = workStartHour;
                    defaultMinute = 0;
                }
                // 2. Nếu giờ sớm nhất >= 19h tối
                else if (defaultHour >= workEndHour) {
                    // Tự động nhảy sang 7h sáng ngày hôm sau
                    defaultHour = workStartHour;
                    defaultMinute = 0;

                    // Tăng ngày trong ô input date lên 1 ngày
                    let tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                    dateInput.value = tomorrow.toISOString().split("T")[0];
                }

                // Định dạng HH:mm
                timeInput.value = `${String(defaultHour).padStart(2, "0")}:${String(defaultMinute).padStart(2, "0")}`;
            }

            /**
             * Hàm kiểm tra khi người dùng thay đổi Ngày/Giờ hẹn.
             */
            function validateTime() {
                if (!timeInput || !dateInput) return;

                const now = new Date();
                const selectedDateStr = dateInput.value;
                const [selectedHour, selectedMinute] = timeInput.value.split(":").map(Number);

                const selectedDateTime = new Date(selectedDateStr);
                // Đảm bảo UTC không ảnh hưởng, chỉ lấy giờ/phút đã chọn
                selectedDateTime.setHours(selectedHour, selectedMinute, 0, 0);

                // Tính giờ sớm nhất có thể đặt (Hiện tại + 2 tiếng)
                const earliestBookingTime = new Date(now.getTime() + bufferHours * 60 * 60 * 1000);

                // LỖI 1: CHỌN GIỜ NGOÀI GIỜ LÀM VIỆC (7:00 - 19:00)
                if (selectedHour < workStartHour || selectedHour > workEndHour || (selectedHour === workEndHour && selectedMinute > 0)) {
                    alert("Giờ làm việc của trung tâm là từ 07:00 đến 19:00. Vui lòng chọn lại.");
                    setDefaultTime(); // Đặt lại giờ mặc định
                    return;
                }

                // LỖI 2: CHỌN GIỜ SỚM HƠN (HIỆN TẠI + 2 TIẾNG)
                // Phải so sánh khi ngày được chọn là ngày hiện tại.
                const today = now.toISOString().split("T")[0];
                if (selectedDateStr === today && selectedDateTime < earliestBookingTime) {
                    alert(`Vui lòng đặt lịch trước giờ hiện tại ít nhất ${bufferHours} tiếng (để di chuyển xe).`);
                    setDefaultTime(); // Đặt lại giờ mặc định
                    return;
                }

                // LỖI 3: CHỌN GIỜ QUÁ GẦN GIỜ ĐÓNG CỬA (ví dụ: đặt lúc 18:31)
                const closingTime = (workEndHour * 60) + 0; // 19:00
                const selectedTimeInMinutes = (selectedHour * 60) + selectedMinute;

                // Thời gian sớm nhất có thể đặt để hoàn thành dịch vụ (đóng cửa - 30 phút)
                const latestServiceStart = closingTime - minServiceTimeMinutes; // 18:30

                if (selectedTimeInMinutes > latestServiceStart) {
                    alert(`Đã quá gần giờ đóng cửa (19:00). Dịch vụ cần tối thiểu ${minServiceTimeMinutes} phút. Vui lòng chọn giờ trước 18:30 hoặc đặt cho ngày hôm sau.`);
                    // Đặt lại về giờ cuối cùng cho phép trong ngày
                    timeInput.value = "18:30";
                    return;
                }
            }

            // Chạy khi tải trang để đặt giờ mặc định
            setDefaultTime();

            // Gắn sự kiện kiểm tra khi người dùng thay đổi
            if (timeInput) timeInput.addEventListener("change", validateTime);
            if (dateInput) dateInput.addEventListener("change", validateTime);
        });
    </script>
}