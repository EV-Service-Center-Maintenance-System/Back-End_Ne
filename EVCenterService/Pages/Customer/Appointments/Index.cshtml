@page
@model EVCenterService.Pages.Customer.Appointments.IndexModel
@{
    Layout = "_AppLayout";
    ViewData["Title"] = "Customer Order List";
}

<h2 class="mb-3">Customer Order List</h2>

@if (Model.Bookings == null || !Model.Bookings.Any())
{
    <div class="alert alert-info">Bạn chưa có lịch hẹn nào.</div>
}
else
{
    <table class="table table-hover table-bordered align-middle">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Xe</th>
                <th>Dịch vụ</th>
                <th>Ngày hẹn</th>
                <th>Ghi chú</th>
                <th>Trạng thái</th>
                <th>Tổng tiền</th>
                <th class="text-center">Hành động</th>
            </tr>
        </thead>
        <tbody>
            @{
                int index = 1;
            }

            @foreach (var order in Model.Bookings)
            {
                var serviceNames = string.Join(", ", order.OrderDetails
                .Where(d => d.Service != null)
                .Select(d => d.Service.Name));

                var badgeClass = order.Status?.ToLower() switch
                {
                    "pending" => "bg-warning text-dark",
                    "confirmed" => "bg-primary",
                    "inprogress" => "bg-info text-dark",
                    "completed" => "bg-success",
                    "cancelled" => "bg-danger",
                    _ => "bg-secondary"
                };

                string displayNote = string.Empty;

                if (!string.IsNullOrEmpty(order.ChecklistNote))
                {
                    displayNote += order.ChecklistNote;
                }

                if (order.Technician != null)
                {
                    if (!string.IsNullOrEmpty(displayNote))
                        displayNote += " — ";

                    displayNote += $"👨‍🔧 Technician: {order.Technician.FullName}";
                }

                <tr>
                    <td>@index</td>
                    <td>@order.Vehicle?.Model</td>
                    <td>@serviceNames</td>
                    <td>@order.AppointmentDate.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@displayNote</td>
                    <td>
                        <span class="badge @badgeClass">
                            @(order.Status?.ToUpperInvariant() ?? "UNKNOWN")
                        </span>
                    </td>
                    <td>@string.Format("{0:N0} đ", order.TotalCost ?? 0)</td>
                    <td class="text-center">
                        <a asp-page="Edit" asp-route-id="@order.OrderId" class="btn btn-sm btn-primary">Sửa</a>
                        <a asp-page="Delete" asp-route-id="@order.OrderId" class="btn btn-sm btn-danger"
                           onclick="return confirm('Bạn có chắc chắn muốn xóa lịch hẹn này không?');">Xóa</a>
                    </td>
                </tr>

                index++;
            }
        </tbody>
    </table>
}

<a asp-page="Create" class="btn btn-success mt-3">+ Đặt lịch mới</a>
