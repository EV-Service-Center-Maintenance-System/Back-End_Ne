@page
@model EVCenterService.Pages.Customer.Appointments.EditModel
@{
    Layout = "_CustomerLayout";
	ViewData["Title"] = "Update Order";
}
<div class="page-header header-card-blue">
    <h1 class="mb-0">Chỉnh sửa Lịch hẹn</h1>
</div>

<form method="post" class="card data-card p-4 mt-4">

    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
    <div class="form-group mb-3">
        <label class="fw-bold">Chọn xe:</label>
        <select id="select-vehicle-edit" asp-for="Booking.VehicleId" asp-items="Model.VehicleList" class="form-select" required>
        </select>
    </div>

    <div class="form-group mb-3">
        <label class="fw-bold">Chọn dịch vụ:</label>
        <div class="row">
            @foreach (var svc in Model.ServiceList)
            {
                var isChecked = Model.SelectedServiceIds.Contains(svc.ServiceId);
                <div class="col-md-6 mb-2">
                    <div class="form-check">
                        <input class="form-check-input service-checkbox"
                               type="checkbox"
                               name="SelectedServiceIds"
                               value="@svc.ServiceId"
                               data-price="@svc.BasePrice"
                               id="svc_@svc.ServiceId"
                               @(isChecked ? "checked" : "") />
                        <label class="form-check-label" for="svc_@svc.ServiceId">
                            @svc.Name (@((svc.BasePrice ?? 0).ToString("N0")) đ)
                        </label>
                    </div>
                </div>
            }
        </div>
        <small class="text-muted d-block mt-1">Bạn có thể chọn nhiều dịch vụ cùng lúc.</small>
    </div>

    <div id="priceSection" class="form-group mb-3" style="display:none;">
        <label class="fw-bold">Tổng chi phí:</label>
        <input id="totalPrice" type="text" class="form-control" readonly value="0 đ" />
    </div>

    <div class="form-group mb-3">
        <label class="fw-bold">Ngày hẹn:</label>
        <input asp-for="Booking.AppointmentDate" type="date"
               class="form-control"
               value="@Model.Booking.AppointmentDate.ToString("yyyy-MM-dd")"
               min="@DateTime.Now.ToString("yyyy-MM-dd")"
               required />
    </div>

    <div class="form-group mb-3">
        <label class="fw-bold">Giờ hẹn:</label>
        <input asp-for="SelectedTime" type="time"
               class="form-control"
               value="@Model.SelectedTime.ToString(@"hh\:mm")"
               required />
    </div>

    <div class="form-group mb-3">
        <label class="fw-bold">Ghi chú:</label>
        <textarea asp-for="Booking.ChecklistNote"
                  class="form-control"
                  rows="3"
                  placeholder="VD: kiểm tra phanh, thay dầu, vệ sinh nội thất...">@Model.Booking.ChecklistNote</textarea>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Cập nhật</button>
        <a asp-page="Index" class="btn btn-secondary ms-2">Hủy</a>
    </div>
</form>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const checkboxes = document.querySelectorAll(".service-checkbox");
            const totalPriceInput = document.getElementById("totalPrice");
            const priceSection = document.getElementById("priceSection");

            new TomSelect('#select-vehicle-edit', {
                placeholder: '-- Chọn xe của bạn --',
                create: false
            });

            function updateTotal() {
                let total = 0;
                checkboxes.forEach(cb => {
                    if (cb.checked) total += parseFloat(cb.dataset.price || 0);
                });
                if (total > 0) {
                    totalPriceInput.value = total.toLocaleString("vi-VN") + " đ";
                    priceSection.style.display = "block";
                } else {
                    priceSection.style.display = "none";
                }
            }

            checkboxes.forEach(chk => chk.addEventListener("change", updateTotal));

            // Hiển thị tổng ngay khi mở trang
            updateTotal();

            // ===== BẮT ĐẦU LOGIC VÔ HIỆU HÓA DỊCH VỤ =====

            // ID Dịch vụ (phải khớp CSDL)
            const generalInspectionId = 4;
            const mainServiceIds = [1, 2, 3]; // Battery, Brake, Cooling

            const generalCheckbox = document.getElementById('svc_' + generalInspectionId);
            const mainCheckboxes = mainServiceIds.map(id => document.getElementById('svc_' + id));

            function handleInspectionLogic() {
                // Kiểm tra xem generalCheckbox có tồn tại không (nếu dịch vụ bị xóa)
                if (!generalCheckbox) return;

                if (generalCheckbox.checked) {
                    // 1. NẾU CHỌN "General Inspection"
                    mainCheckboxes.forEach(chk => {
                        if (chk) { // Kiểm tra chk tồn tại
                            if (chk.checked) {
                                chk.checked = false; // Bỏ chọn
                            }
                            chk.disabled = true; // Vô hiệu hóa
                            chk.closest('.form-check').classList.add('text-muted');
                        }
                    });
                } else {
                    // 2. NẾU BỎ CHỌN "General Inspection"
                    mainCheckboxes.forEach(chk => {
                        if (chk) {
                            chk.disabled = false; // Kích hoạt lại
                            chk.closest('.form-check').classList.remove('text-muted');
                        }
                    });
                }

                // Tính lại tổng giá sau khi thay đổi
                updateTotal();
            }

            if (generalCheckbox) {
                generalCheckbox.addEventListener('change', handleInspectionLogic);
            }

            // Chạy logic này ngay khi tải trang (RẤT QUAN TRỌNG CHO TRANG EDIT)
            handleInspectionLogic();

            // ===== KẾT THÚC LOGIC VÔ HIỆU HÓA DỊCH VỤ =====

        });
    </script>
}