@page "{id:int}"
@model EVCenterService.Pages.Customer.Invoices.DetailsModel
@{
    ViewData["Title"] = "Hóa Đơn Dịch Vụ";
    Layout = "_CustomerLayout";
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card data-card">
            <div class="card-header text-center py-4 bg-darker text-white">
                <h2 class="mb-0">HÓA ĐƠN DỊCH VỤ</h2>
                <p class="text-muted mb-0">Mã hóa đơn: #HD-@(Model.Invoice.InvoiceId)</p>
            </div>
            <div class="card-body p-5">


                @if (TempData["StatusMessage"] != null)
                {
                    <div class="alert alert-success">@TempData["StatusMessage"]</div>
                }
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
                }

                <div class="row mb-4">
                    <div class="col-md-6">
                        @if (Model.Invoice.Order != null)
                        {
                            <p class="mb-0"><strong>Khách hàng:</strong> @(Model.Invoice.Order.User?.FullName)</p>
                            <p class="mb-0"><strong>Xe:</strong> @(Model.Invoice.Order.Vehicle?.Model) - @(Model.Invoice.Order.Vehicle?.Vin)</p>
                            <p class="mb-0"><strong>Ngày tạo:</strong> @(Model.Invoice.IssueDate?.ToString("dd/MM/yyyy"))</p>
                        }
                        else if (Model.Invoice.Subscription != null)
                        {
                            <p class="mb-0"><strong>Khách hàng:</strong> @(Model.Invoice.Subscription.User?.FullName)</p>
                            <p class="mb-0"><strong>Gói dịch vụ:</strong> @(Model.Invoice.Subscription.Plan?.Name)</p>
                            <p class="mb-0"><strong>Ngày tạo:</strong> @(Model.Invoice.IssueDate?.ToString("dd/MM/yyyy"))</p>
                            <p class="mb-0"><strong>Ngày kết thúc:</strong> @(Model.Invoice.Subscription.EndDate.ToString("dd/MM/yyyy"))</p>
                        }
                    </div>
                    <div class="col-md-6 text-md-end">
                        @if (Model.Invoice.Status == "Paid")
                        {
                            <span class="badge badge-custom bg-success fs-6">ĐÃ THANH TOÁN</span>
                        }
                        else
                        {
                            <span class="badge badge-custom bg-danger fs-6">CHƯA THANH TOÁN</span>
                        }
                    </div>
                </div>

                <div class="table-responsive mb-4">
                    <table class="table table-custom table-dark table-borderless mb-0" style="--bs-table-bg: #212529;">
                        <thead class="">
                            <tr>
                                <th>#</th>
                                <th>Nội dung</th>
                                <th class="text-end">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>

                            @if (Model.Invoice.Order != null)
                            {
                                @foreach (var (detail, index) in Model.Invoice.Order.OrderDetails.Select((v, i) => (v, i + 1)))
                                {
                                    <tr>
                                        <td>@index</td>
                                        <td><strong>Dịch vụ:</strong> @(detail.Service?.Name)</td>
                                        <td class="text-end">@(detail.UnitPrice?.ToString("N0"))đ</td>
                                    </tr>
                                }
                                @foreach (var (part, index) in Model.Invoice.Order.PartsUseds.Select((v, i) => (v, i + 1 + Model.Invoice.Order.OrderDetails.Count)))
                                {
                                    <tr>
                                        <td>@index</td>
                                        <td><strong>Phụ tùng:</strong> @(part.Part?.Name) (SL: @(part.Quantity))</td>
                                        <td class="text-end">@((part.Part?.UnitPrice * part.Quantity)?.ToString("N0"))đ</td>
                                    </tr>
                                }
                            }
                            else if (Model.Invoice.Subscription != null)
                            {
                                <tr>
                                    <td>1</td>
                                    <td>
                                        <strong>Gói dịch vụ:</strong> @(Model.Invoice.Subscription.Plan.Name)
                                        <small class="d-block text-muted">Thời hạn: @(Model.Invoice.Subscription.Plan.DurationDays) ngày</small>
                                    </td>
                                    <td class="text-end">@(Model.Invoice.Subscription.Plan.PriceVnd.ToString("N0"))đ</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot style="border-top: 1px solid #30363d !important;">
                            <tr>
                                <td colspan="2" class="text-end fw-bold">Tổng cộng</td>
                                <td class="text-end fw-bold fs-5">@(Model.Invoice.Amount?.ToString("N0"))đ</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                @if (Model.Invoice.Status == "Unpaid")
                {
                    <div class="text-center">
                        <h5 class="mb-3">Thanh toán ngay</h5>
                        <form method="post">
                            <button type="submit" asp-page-handler="PayWithVnPay" asp-route-id="@Model.Invoice.InvoiceId" class="btn btn-primary btn-lg">
                                <i class="bi bi-credit-card-fill me-2"></i> Thanh toán bằng VNPay
                            </button>
                        </form>
                    </div>
                }
            </div>
            <div class="card-footer text-center" style="background-color: transparent; border-top-color: #30363d;">
                <button class="btn btn-secondary" onclick="window.print();"><i class="bi bi-printer me-2"></i>In Hóa Đơn</button>
            </div>
        </div>
    </div>
</div>